<VirtualHost *:80>
    ServerName afs-mappingxt.local
    ServerAdmin admin@example.com
    
    DocumentRoot /var/www/html
    
    # Enable PHP-FPM via proxy
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/php-fpm.sock|fcgi://localhost"
    </FilesMatch>
    
    # Directory permissions
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Disable directory listing
        Options -Indexes
        
        # Enable URL rewriting
        <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # Block access to hidden files except .well-known
            RewriteCond %{REQUEST_URI} "!(^|/)\.well-known/([^./]+./?)+$" [NC]
            RewriteCond %{SCRIPT_FILENAME} -d [OR]
            RewriteCond %{SCRIPT_FILENAME} -f
            RewriteRule "(^|/)\." - [F]
            
            # Deny access to sensitive files
            RewriteRule ^(config\.php|composer\.(json|lock))$ - [F,L]
            
            # Deny access to database files
            RewriteRule ^db/.+ - [F,L]
        </IfModule>
    </Directory>
    
    # Protect sensitive directories
    <DirectoryMatch "^/var/www/html/(db|logs|\.git|\.github|scripts)">
        Require all denied
    </DirectoryMatch>
    
    # Protect configuration and composer files
    <FilesMatch "^(config\.php|composer\.(json|lock)|\.env)$">
        Require all denied
    </FilesMatch>
    
    # Allow access to API endpoints
    <Directory /var/www/html/api>
        Options -Indexes
        AllowOverride None
        Require all granted
        
        <FilesMatch \.php$>
            SetHandler "proxy:unix:/run/php/php-fpm.sock|fcgi://localhost"
        </FilesMatch>
    </Directory>
    
    # FPM status and ping endpoints (optional, for monitoring)
    <Location /fpm-status>
        SetHandler "proxy:unix:/run/php/php-fpm.sock|fcgi://localhost"
        Require local
    </Location>
    
    <Location /fpm-ping>
        SetHandler "proxy:unix:/run/php/php-fpm.sock|fcgi://localhost"
        Require local
    </Location>
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/afs-mappingxt-error.log
    CustomLog ${APACHE_LOG_DIR}/afs-mappingxt-access.log combined
    
    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE application/javascript application/x-javascript application/json
    </IfModule>
    
    # Cache control for static assets
    <IfModule mod_expires.c>
        <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 month"
            Header append Cache-Control "public"
        </FilesMatch>
    </IfModule>
    
    # Security headers
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        
        # Remove server signature for security
        Header unset Server
        Header always unset X-Powered-By
        
        # HSTS (uncomment for production with HTTPS)
        # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    </IfModule>
</VirtualHost>

# SSL VirtualHost (uncomment and configure for HTTPS)
# <VirtualHost *:443>
#     ServerName afs-mappingxt.local
#     ServerAdmin admin@example.com
#     
#     DocumentRoot /var/www/html
#     
#     SSLEngine on
#     SSLCertificateFile /path/to/certificate.crt
#     SSLCertificateKeyFile /path/to/private.key
#     SSLCertificateChainFile /path/to/chain.crt
#     
#     # Include same configuration as port 80
#     Include /etc/apache2/sites-available/000-default-common.conf
# </VirtualHost>
