version: 1

# Mehrere Quellen (AFS DB, FileDB, FileCatcher) und ein Ziel (EVO)
sources:
  afs:
    schema: "schemas/afs.yml"
  afs_filedb:
    schema: "schemas/afs-filedb.yml"
  afs_bilder:
    schema: "schemas/AFS_Bilder_filecatcher.yml"
  afs_dokumente:
    schema: "schemas/AFS_Dokumente_filecatcher.yml"

# Ziel
target:
  evo:
    schema: "schemas/evo.yml"

entities:

  artikel:
    from: afs.Artikel
    to:   evo.artikel

    map:
      evo.artikel.model:             afs.Artikel.Artikelnummer | trim
      evo.artikel.name:              afs.Artikel.Bezeichnung | trim | null_if_empty
      evo.artikel.ean:               afs.Artikel.EANNummer
      evo.artikel.description_html:  $func.transform_rtf_to_html(afs.Artikel.Langtext)
      evo.artikel.promo_html:        $func.transform_rtf_to_html(afs.Artikel.Werbetext1)
      evo.artikel.note_html:         $func.transform_rtf_to_html(afs.Artikel.Bemerkung)
      evo.artikel.unit:              afs.Artikel.Einheit | trim | null_if_empty
      evo.artikel.gross_weight:      afs.Artikel.Bruttogewicht | to_decimal
      evo.artikel.price:             afs.Artikel.VK3 | to_decimal | round(2)
      evo.artikel.tax_class_id:      $func.tax_map(afs.Artikel.Umsatzsteuer)
      evo.artikel.stock:             afs.Artikel.Bestand | to_int
      evo.artikel.status:            $func.bool_to_int(afs.Artikel.Internet)
      evo.artikel.category:          afs.Artikel.Warengruppe
      evo.artikel.seo_slug:          afs.Artikel.Bezeichnung | slugify
      evo.artikel.is_master:         $func.article_master_flag(afs.Artikel.Zusatzfeld07 | trim)
      evo.artikel.master_model:      $func.article_master_number(afs.Artikel.Zusatzfeld07 | trim)
      evo.artikel.products_image:    afs.Artikel.Bild1 | trim | null_if_empty
      evo.artikel.products_name:     afs.Artikel.Bezeichnung | trim | null_if_empty
      evo.artikel.products_description: $func.transform_rtf_to_html(afs.Artikel.Langtext)
      evo.artikel.source_hash:       afs.Artikel.Update
      evo.artikel.change:            =0

    delta:
      fields: [name, ean, description_html, promo_html, note_html, unit, gross_weight, price, tax_class_id, stock, status, category, seo_slug, is_master, master_model, products_image, products_name, products_description, source_hash]

    flags:
      on_insert:
        evo.artikel.change: =1
        evo.artikel.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.artikel.change: =1
        evo.artikel.updated_at: $func.now()
      on_update_when_no_change:
        evo.artikel.change: =0

    orphan_policy:
      scope: evo.artikel
      match_key: [model]
      actions:
        - set:
            evo.artikel.status: =0
            evo.artikel.change: =1

  artikel_meta:
    from: afs_filedb.Artikel
    to:   evo.artikel

    map:
      evo.artikel.model:            afs_filedb.Artikel.Artikelnummer | trim
      evo.artikel.meta_title:       afs_filedb.Artikel.Meta_Title | trim | null_if_empty
      evo.artikel.meta_description: afs_filedb.Artikel.Meta_Description | trim | null_if_empty

    delta:
      fields: [meta_title, meta_description]

    flags:
      on_insert:
        evo.artikel.change: =1
        evo.artikel.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.artikel.change: =1
        evo.artikel.updated_at: $func.now()

  warengruppe:
    from: afs.Warengruppe
    to:   evo.category

    map:
      evo.category.cat_id:           afs.Warengruppe.Warengruppe
      evo.category.name:             afs.Warengruppe.Bezeichnung | trim | null_if_empty
      evo.category.level:            afs.Warengruppe.Ebene
      evo.category.attachment:       afs.Warengruppe.Anhang
      evo.category.description_html: $func.transform_rtf_to_html(afs.Warengruppe.Beschreibung)
      evo.category.description:      $func.transform_rtf_to_html(afs.Warengruppe.Beschreibung)
      evo.category.status:           $func.bool_to_int(afs.Warengruppe.Internet)
      evo.category.image:            afs.Warengruppe.Bild
      evo.category.image_large:      afs.Warengruppe.Bild_gross
      evo.category.meta_title:       $func.category_meta_title(afs.Warengruppe.Bezeichnung | trim, null)
      evo.category.meta_description: $func.category_meta_description(afs.Warengruppe.Bezeichnung | trim, null)
      evo.category.source_hash:      afs.Warengruppe.Update
      evo.category.change:           =0

    delta:
      fields: [name, level, attachment, description_html, description, status, image, image_large, meta_title, meta_description, source_hash]

    flags:
      on_insert:
        evo.category.change: =1
        evo.category.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.category.change: =1
        evo.category.updated_at: $func.now()
      on_update_when_no_change:
        evo.category.change: =0

  media_bilder:
    from: afs_bilder.file_vault
    to:   evo.media

    map:
      evo.media.file_name:  $func.coalesce($func.image_guard(file_vault.mime, file_vault.file_name), $func.image_guard(file_vault.mime, file_vault.stored_file), file_vault.file_name)
      evo.media.mime:       file_vault.mime
      evo.media.file_size:  file_vault.size
      evo.media.hash:       $func.image_guard(file_vault.mime, file_vault.checksum)
      evo.media.stored_file: $func.image_guard(file_vault.mime, file_vault.stored_file)
      evo.media.stored_path: $func.image_guard(file_vault.mime, file_vault.stored_path)
      evo.media.stored_at:   $func.image_guard(file_vault.mime, file_vault.stored_at)
      evo.media.kind:       =image
      evo.media.status:     =1
      evo.media.change:     =0

    delta:
      fields: [file_name, mime, file_size, stored_file, stored_path]

    flags:
      on_insert:
        evo.media.change:     =1
        evo.media.upload:     =1
        evo.media.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.media.change:     =1
        evo.media.upload:     =1
        evo.media.updated_at: $func.now()
      on_update_when_no_change:
        evo.media.change:     =0

    orphan_policy:
      scope: evo.media
      match_key: [hash, kind]
      actions:
        - set:
            evo.media.status: =0
            evo.media.change: =1

  media_dokumente:
    from: afs_dokumente.file_vault
    to:   evo.media

    map:
      evo.media.file_name:  $func.coalesce($func.document_guard(file_vault.mime, file_vault.file_name), $func.document_guard(file_vault.mime, file_vault.stored_file), file_vault.file_name)
      evo.media.mime:       file_vault.mime
      evo.media.file_size:  file_vault.size
      evo.media.hash:       $func.document_guard(file_vault.mime, file_vault.checksum)
      evo.media.stored_file: file_vault.stored_file
      evo.media.stored_path: file_vault.stored_path
      evo.media.stored_at:   file_vault.stored_at
      evo.media.kind:       =document
      evo.media.status:     =1
      evo.media.change:     =0

    delta:
      fields: [file_name, mime, file_size, stored_file, stored_path]

    flags:
      on_insert:
        evo.media.change:     =1
        evo.media.upload:     =1
        evo.media.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.media.change:     =1
        evo.media.upload:     =1
        evo.media.updated_at: $func.now()
      on_update_when_no_change:
        evo.media.change:     =0

    orphan_policy:
      scope: evo.media
      match_key: [hash, kind]
      actions:
        - set:
            evo.media.status: =0
            evo.media.change: =1

  media_relation_bilder:
    from: afs_bilder.file_vault
    to:   evo.media_relation

    map:
      evo.media_relation.file_name: file_vault.file_name
      evo.media_relation.entity_type: $func.media_entity_type(file_vault.art_type, file_vault.art_id, file_vault.cat_id)
      evo.media_relation.entity_id:   $func.media_entity_id(file_vault.art_type, file_vault.art_id, file_vault.cat_id)
      evo.media_relation.hash:        $func.image_guard(file_vault.mime, file_vault.checksum)
      evo.media_relation.position:    =0
      evo.media_relation.status:      =1
      evo.media_relation.change:      =0

    delta:
      fields: [entity_type, entity_id, hash]

    flags:
      on_insert:
        evo.media_relation.change:     =1
        evo.media_relation.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.media_relation.change:     =1
        evo.media_relation.updated_at: $func.now()
      on_update_when_no_change:
        evo.media_relation.change:     =0

    orphan_policy:
      scope: evo.media_relation
      match_key: [file_name, entity_type, entity_id]
      actions:
        - set:
            evo.media_relation.status: =0
            evo.media_relation.change: =1

  media_relation_dokumente:
    from: afs.Dokument
    to:   evo.media_relation

    map:
      evo.media_relation.file_name: afs.Dokument.Titel | basename | null_if_empty
      evo.media_relation.entity_type: =article
      evo.media_relation.entity_id:   afs.Dokument.Artikel | trim | null_if_empty
      evo.media_relation.position:    =0
      evo.media_relation.status:      =1
      evo.media_relation.change:      =0

    delta:
      fields: [entity_id]

    flags:
      on_insert:
        evo.media_relation.change:     =1
        evo.media_relation.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.media_relation.change:     =1
        evo.media_relation.updated_at: $func.now()
      on_update_when_no_change:
        evo.media_relation.change:     =0

    orphan_policy:
      scope: evo.media_relation
      match_key: [file_name, entity_type, entity_id]
      actions:
        - set:
            evo.media_relation.status: =0
            evo.media_relation.change: =1

  attribute_1:
    from: afs.Artikel
    to:   evo.attribute

    map:
      evo.attribute.name:       afs.Artikel.Zusatzfeld03 | trim | null_if_empty
      evo.attribute.updated_at: $func.now()

    delta:
      fields: [name]

  attribute_2:
    from: afs.Artikel
    to:   evo.attribute

    map:
      evo.attribute.name:       afs.Artikel.Zusatzfeld04 | trim | null_if_empty
      evo.attribute.updated_at: $func.now()

    delta:
      fields: [name]

  attribute_3:
    from: afs.Artikel
    to:   evo.attribute

    map:
      evo.attribute.name:       afs.Artikel.Zusatzfeld05 | trim | null_if_empty
      evo.attribute.updated_at: $func.now()

    delta:
      fields: [name]

  attribute_4:
    from: afs.Artikel
    to:   evo.attribute

    map:
      evo.attribute.name:       afs.Artikel.Zusatzfeld06 | trim | null_if_empty
      evo.attribute.updated_at: $func.now()

    delta:
      fields: [name]

  artikel_attribute_1:
    from: afs.Artikel
    to:   evo.artikel_attribute

    map:
      evo.artikel_attribute.id:           afs.Artikel.Artikelnummer | trim | null_if_empty
      evo.artikel_attribute.attribute_id: afs.Artikel.Zusatzfeld03 | trim | null_if_empty
      evo.artikel_attribute.value:        afs.Artikel.Zusatzfeld15 | trim | null_if_empty
      evo.artikel_attribute.status:       =1
      evo.artikel_attribute.updated_at:   $func.now()

    delta:
      fields: [value]

  artikel_attribute_2:
    from: afs.Artikel
    to:   evo.artikel_attribute

    map:
      evo.artikel_attribute.id:           afs.Artikel.Artikelnummer | trim | null_if_empty
      evo.artikel_attribute.attribute_id: afs.Artikel.Zusatzfeld04 | trim | null_if_empty
      evo.artikel_attribute.value:        afs.Artikel.Zusatzfeld16 | trim | null_if_empty
      evo.artikel_attribute.status:       =1
      evo.artikel_attribute.updated_at:   $func.now()

    delta:
      fields: [value]

  artikel_attribute_3:
    from: afs.Artikel
    to:   evo.artikel_attribute

    map:
      evo.artikel_attribute.id:           afs.Artikel.Artikelnummer | trim | null_if_empty
      evo.artikel_attribute.attribute_id: afs.Artikel.Zusatzfeld05 | trim | null_if_empty
      evo.artikel_attribute.value:        afs.Artikel.Zusatzfeld17 | trim | null_if_empty
      evo.artikel_attribute.status:       =1
      evo.artikel_attribute.updated_at:   $func.now()

    delta:
      fields: [value]

  artikel_attribute_4:
    from: afs.Artikel
    to:   evo.artikel_attribute

    map:
      evo.artikel_attribute.id:           afs.Artikel.Artikelnummer | trim | null_if_empty
      evo.artikel_attribute.attribute_id: afs.Artikel.Zusatzfeld06 | trim | null_if_empty
      evo.artikel_attribute.value:        afs.Artikel.Zusatzfeld18 | trim | null_if_empty
      evo.artikel_attribute.status:       =1
      evo.artikel_attribute.updated_at:   $func.now()

    delta:
      fields: [value]

  artikel_system:
    from: afs.Artikel
    to:   evo.artikel_system

    map:
      evo.artikel_system.id:     afs.Artikel.Artikelnummer | trim | null_if_empty
      evo.artikel_system.afs_id: afs.Artikel.Artikel

  category_system:
    from: afs.Warengruppe
    to:   evo.category_system

    map:
      evo.category_system.id:     afs.Warengruppe.Warengruppe
      evo.category_system.afs_id: afs.Warengruppe.Warengruppe

  attribute_system_1:
    from: afs.Artikel
    to:   evo.attribute_system

    map:
      evo.attribute_system.id: afs.Artikel.Zusatzfeld03 | trim | null_if_empty

  attribute_system_2:
    from: afs.Artikel
    to:   evo.attribute_system

    map:
      evo.attribute_system.id: afs.Artikel.Zusatzfeld04 | trim | null_if_empty

  attribute_system_3:
    from: afs.Artikel
    to:   evo.attribute_system

    map:
      evo.attribute_system.id: afs.Artikel.Zusatzfeld05 | trim | null_if_empty

  attribute_system_4:
    from: afs.Artikel
    to:   evo.attribute_system

    map:
      evo.attribute_system.id: afs.Artikel.Zusatzfeld06 | trim | null_if_empty

  artikel_attribute_system_1:
    from: afs.Artikel
    to:   evo.artikel_attribute_system

    map:
      evo.artikel_attribute_system.id: $func.concat(afs.Artikel.Artikelnummer, ':', afs.Artikel.Zusatzfeld03)

  artikel_attribute_system_2:
    from: afs.Artikel
    to:   evo.artikel_attribute_system

    map:
      evo.artikel_attribute_system.id: $func.concat(afs.Artikel.Artikelnummer, ':', afs.Artikel.Zusatzfeld04)

  artikel_attribute_system_3:
    from: afs.Artikel
    to:   evo.artikel_attribute_system

    map:
      evo.artikel_attribute_system.id: $func.concat(afs.Artikel.Artikelnummer, ':', afs.Artikel.Zusatzfeld05)

  artikel_attribute_system_4:
    from: afs.Artikel
    to:   evo.artikel_attribute_system

    map:
      evo.artikel_attribute_system.id: $func.concat(afs.Artikel.Artikelnummer, ':', afs.Artikel.Zusatzfeld06)
