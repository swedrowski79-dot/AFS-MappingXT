version: 1

# Mehrere Quellen (AFS DB, FileDB, FileCatcher) und ein Ziel (EVO)
sources:
  afs:
    schema: "schemas/afs.yml"
  afs_filedb:
    schema: "schemas/afs-filedb.yml"
  afs_bilder:
    schema: "schemas/AFS_Bilder_filecatcher.yml"
  afs_dokumente:
    schema: "schemas/AFS_Dokumente_filecatcher.yml"

# Ziel
target:
  evo:
    schema: "schemas/evo.yml"

entities:

  artikel:
    from: afs.Artikel
    to:   evo.artikel

    map:
      evo.artikel.model:             afs.Artikel.Artikelnummer | trim
      evo.artikel.name:              afs.Artikel.Bezeichnung | trim | null_if_empty
      evo.artikel.ean:               afs.Artikel.EANNummer
      evo.artikel.description_html:  $func.transform_rtf_to_html(afs.Artikel.Langtext)
      evo.artikel.promo_html:        $func.transform_rtf_to_html(afs.Artikel.Werbetext1)
      evo.artikel.note_html:         $func.transform_rtf_to_html(afs.Artikel.Bemerkung)
      evo.artikel.unit:              afs.Artikel.Einheit | trim | null_if_empty
      evo.artikel.gross_weight:      afs.Artikel.Bruttogewicht | to_decimal
      evo.artikel.price:             afs.Artikel.VK3 | to_decimal | round(2)
      evo.artikel.tax_class_id:      $func.tax_map(afs.Artikel.Umsatzsteuer)
      evo.artikel.stock:             afs.Artikel.Bestand | to_int
      evo.artikel.status:            $func.bool_to_int(afs.Artikel.Internet)
      evo.artikel.category:          afs.Artikel.Warengruppe
      evo.artikel.seo_slug:          afs.Artikel.Bezeichnung | slugify
      evo.artikel.is_master:         $func.article_master_flag(afs.Artikel.Zusatzfeld07 | trim)
      evo.artikel.master_model:      $func.article_master_number(afs.Artikel.Zusatzfeld07 | trim)
      evo.artikel.products_image:    afs.Artikel.Bild1 | trim | null_if_empty
      evo.artikel.products_name:     afs.Artikel.Bezeichnung | trim | null_if_empty
      evo.artikel.products_description: $func.transform_rtf_to_html(afs.Artikel.Langtext)
      evo.artikel.source_hash:       afs.Artikel.Update
      evo.artikel.change:            =0

    delta:
      fields: [name, ean, description_html, promo_html, note_html, unit, gross_weight, price, tax_class_id, stock, status, category, seo_slug, is_master, master_model, products_image, products_name, products_description, source_hash]

    flags:
      on_insert:
        evo.artikel.change: =1
        evo.artikel.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.artikel.change: =1
        evo.artikel.updated_at: $func.now()
      on_update_when_no_change:
        evo.artikel.change: =0

    orphan_policy:
      scope: evo.artikel
      match_key: [model]
      actions:
        - set:
            evo.artikel.status: =0
            evo.artikel.change: =1

  artikel_meta:
    from: afs_filedb.Artikel
    to:   evo.artikel

    map:
      evo.artikel.model:            afs_filedb.Artikel.Artikelnummer | trim
      evo.artikel.meta_title:       afs_filedb.Artikel.Meta_Title | trim | null_if_empty
      evo.artikel.meta_description: afs_filedb.Artikel.Meta_Description | trim | null_if_empty

    delta:
      fields: [meta_title, meta_description]

    flags:
      on_insert:
        evo.artikel.change: =1
        evo.artikel.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.artikel.change: =1
        evo.artikel.updated_at: $func.now()

  warengruppe:
    from: afs.Warengruppe
    to:   evo.category

    map:
      evo.category.cat_id:           afs.Warengruppe.Warengruppe
      evo.category.name:             afs.Warengruppe.Bezeichnung | trim | null_if_empty
      evo.category.level:            afs.Warengruppe.Ebene
      evo.category.attachment:       afs.Warengruppe.Anhang
      evo.category.description_html: $func.transform_rtf_to_html(afs.Warengruppe.Beschreibung)
      evo.category.description:      $func.transform_rtf_to_html(afs.Warengruppe.Beschreibung)
      evo.category.status:           $func.bool_to_int(afs.Warengruppe.Internet)
      evo.category.image:            afs.Warengruppe.Bild
      evo.category.image_large:      afs.Warengruppe.Bild_gross
      evo.category.meta_title:       $func.category_meta_title(afs.Warengruppe.Bezeichnung | trim, null)
      evo.category.meta_description: $func.category_meta_description(afs.Warengruppe.Bezeichnung | trim, null)
      evo.category.source_hash:      afs.Warengruppe.Update
      evo.category.change:           =0

    delta:
      fields: [name, level, attachment, description_html, description, status, image, image_large, meta_title, meta_description, source_hash]

    flags:
      on_insert:
        evo.category.change: =1
        evo.category.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.category.change: =1
        evo.category.updated_at: $func.now()
      on_update_when_no_change:
        evo.category.change: =0

  bilder:
    from: afs_bilder.file_vault
    to:   evo.bilder

    map:
      evo.bilder.file_name: file_vault.file_name
      evo.bilder.mime:      file_vault.mime
      evo.bilder.file_size: file_vault.size
      evo.bilder.hash:      $func.image_guard(file_vault.mime, file_vault.checksum)
      evo.bilder.stored_file: $func.image_guard(file_vault.mime, file_vault.stored_file)
      evo.bilder.stored_path: $func.image_guard(file_vault.mime, file_vault.stored_path)
      evo.bilder.stored_at:   $func.image_guard(file_vault.mime, file_vault.stored_at)
      evo.bilder.status:    =1
      evo.bilder.change:    =0
      evo.bilder.media_type: file_vault.art_type | to_int
      evo.bilder.art_id:     file_vault.art_id | trim | null_if_empty
      evo.bilder.cat_id:     file_vault.cat_id | trim | null_if_empty

    delta:
      fields: [file_name, mime, file_size, stored_file, stored_path, media_type, art_id, cat_id]

    flags:
      on_insert:
        evo.bilder.change:     =1
        evo.bilder.upload:     =1
        evo.bilder.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.bilder.change:     =1
        evo.bilder.upload:     =1
        evo.bilder.updated_at: $func.now()
      on_update_when_no_change:
        evo.bilder.change:     =0

    orphan_policy:
      scope: evo.bilder
      match_key: [hash]
      actions:
        - set:
            evo.bilder.status: =0
            evo.bilder.change: =1
            # evo.bilder.upload: =0

  dokumente:
    from: afs_dokumente.file_vault
    to:   evo.dokumente

    map:
      evo.dokumente.file_name: file_vault.file_name
      evo.dokumente.title:     file_vault.file_name | normalize_title
      evo.dokumente.mime:      file_vault.mime
      evo.dokumente.file_size: file_vault.size
      evo.dokumente.hash:      $func.document_guard(file_vault.mime, file_vault.checksum)
      evo.dokumente.stored_file: file_vault.stored_file
      evo.dokumente.stored_path: file_vault.stored_path
      evo.dokumente.stored_at:   file_vault.stored_at
      evo.dokumente.kind:      =0
      evo.dokumente.status:    =1
      evo.dokumente.change:    =0

    delta:
      fields: [file_name, title, mime, file_size, kind, stored_file, stored_path]

    flags:
      on_insert:
        evo.dokumente.change:     =1
        evo.dokumente.upload:     =1
        evo.dokumente.updated_at: $func.now()
      on_update_when_delta_changed:
        evo.dokumente.change:     =1
        evo.dokumente.upload:     =1
        evo.dokumente.updated_at: $func.now()
      on_update_when_no_change:
        evo.dokumente.change:     =0

    orphan_policy:
      scope: evo.dokumente
      match_key: [hash]
      actions:
        - set:
            evo.dokumente.status: =0
            evo.dokumente.change: =1
            # evo.dokumente.upload: =0
